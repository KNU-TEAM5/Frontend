<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전해탈지 공정 데이터 분석</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<input type="file" id="fileInput" multiple style="display:none" />

<body>
    <div class="container">
        <div class="header">
            <h1>전해탈지 공정 데이터 분석</h1>
            <h2>AI를 활용한 데이터 분석 결과 및 해설</h2>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchView('DataAnalysis')">데이터 분석 결과</button>
            <button class="tab-button" onclick="switchView('AIInsight')">🤖 AI 해설</button>
            <div class="action-buttons">
                <button class="action-button" onclick="handleDataAdd()">📁 데이터 추가</button>
                <button class="action-button" onclick="openDataCleanup()">🗑️ 데이터 정리</button>
                <button class="action-button primary" onclick="handleAnalyze()">▶️ 분석 시작</button>
            </div>
        </div>

        <div class="content">
            <!-- Data Analysis View -->
            <div id="DataAnalysis-view" class="model-view active">
                <!-- Summary Metrics -->
                <div class="section">
                    <h2 class="section-title">💯 AI 불량 검출 성적표</h2>
                    <div class="metrics-grid" style="position: relative;">
                        <div class="analysis-overlay" id="metrics-overlay">
                            <div class="overlay-message">
                                <h3>📊 데이터 분석 대기 중</h3>
                                <p>'분석 시작' 버튼을 눌러<br>분석을 시작해주세요</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="accuracy-value">--</div>
                            <div class="metric-label">정확도</div>
                            <div class="metric-description">전체 제품 중 정확하게 판단한 비율입니다. 높을 수록 정확히 판단했다는 증거가 돼요.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="precision-value">--</div>
                            <div class="metric-label">정밀도 (불량 판정)</div>
                            <div class="metric-description">불량이라고 판단한 것 중 실제로 불량인 비율입니다. 오탐이 적을수록 좋아요.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="recall-value">--</div>
                            <div class="metric-label">검출률 (불량 발견)</div>
                            <div class="metric-description">실제 불량 중 AI가 찾아낸 비율입니다. 놓치는 불량이 적을수록 좋아요.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="f1-value">--</div>
                            <div class="metric-label">종합 점수</div>
                            <div class="metric-description">정밀도와 검출률의 균형을 나타냅니다. 1에 가까울수록 우수해요.</div>
                        </div>
                    </div>
                </div>

                <!-- Confusion Matrix -->
                <div class="section">
                    <h2 class="section-title">🎯 AI가 얼마나 정확하게 판단했을까요?</h2>
                    <div class="chart-container" style="position: relative;">
                        <div class="analysis-overlay" id="cm-overlay">
                            <div class="overlay-message">
                                <h3>📊 데이터 분석 대기 중</h3>
                                <p>'분석 시작' 버튼을 눌러<br>분석을 시작해주세요</p>
                            </div>
                        </div>
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">혼동 행렬 (Confusion Matrix)</h3>
                        <div class="chart-wrapper">
                            <canvas id="confusionMatrix"></canvas>
                        </div>
                        <div class="chart-caption">
                            <strong>📊 이 그래프는 무엇을 보여주나요?</strong><br>
                            AI의 판단 결과를 4가지로 나눠 보여줍니다. 초록색 막대는 정확한 판단, 빨간색 막대는 잘못된 판단입니다.
                            빨간색 막대가 작을수록 AI가 실수를 적게 했다는 뜻이에요.<br>
                            <em>※ 'A→B'는 실제로는 A였으나 AI가 B라고 판단했다는 것을 뜻합니다.</em>
                        </div>
                    </div>
                </div>

                <!-- Feature Importance -->
                <div class="section">
                    <h2 class="section-title">🔍 어떤 요소가 불량을 판단하는데 가장 중요할까요?</h2>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="featureImportance"></canvas>
                        </div>
                        <div class="chart-caption">
                            <strong>📊 이 그래프는 무엇을 보여주나요?</strong><br>
                            AI가 불량을 판단할 때 각 요소(온도, 압력, 습도)를 얼마나 중요하게 보는지 나타냅니다.
                            막대가 길수록 그 요소가 불량 판정에 큰 영향을 미친다는 의미입니다.
                        </div>
                    </div>
                </div>

                <!-- Classification Report -->
                <div class="section">
                    <h2 class="section-title">📋 상세 성능 리포트</h2>
                    <div class="table-container" style="position: relative;">
                        <div class="analysis-overlay" id="table-overlay">
                            <div class="overlay-message">
                                <h3>📊 데이터 분석 대기 중</h3>
                                <p>'분석 시작' 버튼을 눌러<br>분석을 시작해주세요</p>
                            </div>
                        </div>
                        <table id="classificationReport">
                            <thead>
                                <tr>
                                    <th>구분</th>
                                    <th>정밀도</th>
                                    <th>검출률</th>
                                    <th>종합점수</th>
                                    <th>제품 수</th>
                                </tr>
                            </thead>
                            <tbody id="reportBody">
                            </tbody>
                        </table>
                        <div class="chart-caption">
                            <strong>📊 표를 어떻게 읽나요?</strong><br>
                            <strong>정상 제품:</strong> AI가 정상 제품을 얼마나 잘 판단했는지 보여줍니다.<br>
                            <strong>불량 제품:</strong> AI가 불량 제품을 얼마나 잘 찾아냈는지 보여줍니다.<br>
                            <strong>전체 정확도:</strong> 모든 제품을 종합했을 때의 정확도입니다.<br>
                            숫자가 1에 가까울수록 더 좋은 성능입니다!
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insight View -->
            <div class="ai-insight-container" id="AIInsight-view" style="position: relative;">
                <div class="analysis-overlay" id="ai-overlay">
                    <div class="overlay-message">
                        <h3>🤖 AI 해설 대기 중</h3>
                        <p>'분석 시작' 버튼을 눌러<br>분석을 시작해주세요</p>
                    </div>
                </div>
                <div class="section">
                    <h2 class="section-title">🤖 AI 분석 결론 및 공정 개선 제안</h2>

                    <div class="insight-box">
                        <h3>🖥️ 공정 상태 요약</h3>
                        <div class="insight-content">
                            <p>
                                전해탈지 공정은 온도, 습도, 압력이 일정 범위 안에 있을 때 불량이 거의 발생하지 않는 안정적인 상태로 보입니다. 특히 온도는 약 44~55℃, 습도는
                                25~36%, 압력은 65~83 수준에서 운전될 때 양품 비율이 높게 유지됩니다. 이 구간에 해당하는 데이터가 600건 이상 모였다는 점을 보면, 현재 공정은
                                이
                                범위를 기준으로 관리해도 무리가 없을 만큼 충분한 운영 경험이 쌓인 상태라고 볼 수 있습니다.
                            </p>
                        </div>
                    </div>

                    <div class="insight-box">
                        <h3>🛠️ 관리자용 안전 운전 가이드</h3>
                        <div class="insight-content">
                            <ul>
                                <li>
                                    온도는 44~55℃ 사이를 기본 목표 구간으로 설정하고, 이 범위를 벗어나면 먼저 온도 제어 계통을 확인해 주세요.
                                </li>
                                <li>
                                    습도는 25~36% 구간을 유지하는 것을 권장하며, 특히 겨울철·우기처럼 외부 환경이 달라지는 시기에 가습/제습 장치 세팅을 사전에 조정하는 것이
                                    좋습니다.
                                </li>
                                <li>
                                    압력은 65~83 수준에서 안정적으로 유지되도록 하고, 설비 점검이나 라인 변경 시 압력 변화가 큰지 꼭 확인해 주세요.
                                </li>
                                <li>
                                    설비 자동제어가 있다면, 이 안전 구간을 기준으로 상·하한 알람 값을 설정해 두면 현장에서 즉시 이상 여부를 파악하기 쉽습니다.
                                </li>
                                <li>
                                    신규 작업 조건을 적용할 때는, 처음에는 이 안전 구간 안에서만 시범 운영하고, 문제가 없을 때 점차 범위를 조정하는 방식으로 변화폭을 관리하는
                                    것이 안전합니다.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="insight-box">
                        <h3>👀 추가로 모니터링하면 좋은 포인트</h3>
                        <div class="insight-content">
                            <ul>
                                <li>
                                    온도·습도·압력 중 어느 하나만 안전 구간을 벗어나도 불량이 늘어나는 패턴이 있는지 주기적으로 확인해 주세요.
                                </li>
                                <li>
                                    하루·주간 단위로 시간대별 센서 추세 그래프를 확인해, 특정 시간(예: 교대 직후, 설비 기동 직후)에만 조건이 흔들리지 않는지 점검하는 것이
                                    좋습니다.
                                </li>
                                <li>
                                    안전 구간 밖에서 발생한 불량 사례를 따로 모아, 어떤 조합(예: 높은 온도 + 낮은 습도)에서 문제가 두드러지는지 간단히 비교해 보면, 다음 개선
                                    과제를 뽑아내는 데 도움이 됩니다.
                                </li>
                                <li>
                                    계절 교체 시기나 설비 정기 점검 이후에는, 안전 구간과 실제 운전 값이 얼마나 차이가 나는지를 체크하여, 세팅 값이 바뀌지 않았는지 확인해
                                    주세요.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            삼성, 종합설계프로젝트2
        </div>
    </div>

    <div id="dataCleanupModal" style="
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;">
        <div style="
        background: white;
        padding: 25px;
        width: 420px;
        max-height: 70vh;
        overflow-y: auto;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    ">
            <h2 style="margin-bottom: 15px; color:#667eea;">📁 업로드된 데이터 목록</h2>

            <div id="sensorFilesContainer">불러오는 중...</div>

            <button onclick="closeDataCleanup()" style="margin-top: 20px; width: 100%; padding: 10px;
                   background:#667eea; color:white; border:none; border-radius:8px;">
                닫기
            </button>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://port-0-capstone2-samsung-mig4d3f30c7d6141.sel3.cloudtype.app/api/v1";
        let charts = {};

        window.addEventListener("load", () => {
            const fileInput = document.getElementById("fileInput");
            if (fileInput) {
                fileInput.addEventListener("change", onFileSelected);
            }
        });

        function sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        async function fetchResultsAndRender() {
            try {
                const [fiRes, cmRes, crRes, safeRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/feature-importance`),
                    fetch(`${API_BASE_URL}/confusion-matrix`),
                    fetch(`${API_BASE_URL}/classification-report-rf`),
                    fetch(`${API_BASE_URL}/safe-region`)
                ]);

                if (!fiRes.ok || !cmRes.ok || !crRes.ok || !safeRes.ok) {
                    throw new Error("결과 조회 API 응답 오류");
                }

                const fiData = await fiRes.json();
                const cmData = await cmRes.json();
                const crData = await crRes.json();
                const safeData = await safeRes.json();

                const modelData = transformData(fiData, cmData, crData, safeData);

                updateSummaryCards(modelData.metrics);
                initCharts(modelData);
                updateTable(modelData.metrics);

                // 분석 완료 후 오버레이 숨기기
                document.querySelectorAll(".analysis-overlay").forEach(el => {
                    el.classList.add("hidden");
                });
            } catch (err) {
                console.error(err);
                alert("분석 결과 조회 중 오류가 발생했습니다.");
            }
        }

        async function runFullAnalysisFlow() {
            try {
                const startRes = await fetch(`${API_BASE_URL}/start-analysis`, {
                    method: "POST"
                });

                // 🔎 디버그용: 상태 코드 + 응답 내용 확인
                let debugText = "";
                try {
                    debugText = await startRes.text();
                } catch (e) {
                    debugText = "(응답 body를 읽지 못했음)";
                }

                if (!startRes.ok) {
                    alert(
                        `start-analysis 실패\n` +
                        `HTTP 상태코드: ${startRes.status}\n` +
                        `응답 내용: ${debugText}`
                    );
                    console.error("start-analysis error:", startRes.status, debugText);
                    return;
                }

                await waitForAnalysisCompleted({
                    intervalMs: 2000,
                    timeoutMs: 5 * 60 * 1000
                });

                await fetchResultsAndRender();
                alert("분석이 완료되었습니다. 화면이 최신 결과로 갱신되었습니다.");
            } catch (err) {
                console.error(err);
                alert("분석 처리 중 오류가 발생했습니다.\n" + err.message);
            }
        }

        function openDataCleanup() {
            const modal = document.getElementById("dataCleanupModal");
            modal.style.display = "flex";
            loadSensorFiles(); 
        }

        function closeDataCleanup() {
            const modal = document.getElementById("dataCleanupModal");
            modal.style.display = "none";
        }

        async function loadSensorFiles() {
            const container = document.getElementById("sensorFilesContainer");
            container.innerHTML = "불러오는 중...";

            try {
                const res = await fetch(`${API_BASE_URL}/sensor-files`);
                if (!res.ok) {
                    container.innerHTML = `목록 조회 실패: ${res.status}`;
                    return;
                }

                const data = await res.json();
                const files = data.sensor_files || [];

                if (files.length === 0) {
                    container.innerHTML = "<p>등록된 센서 파일이 없습니다.</p>";
                    return;
                }

                const listHtml = files.map(f => `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="word-break:break-all;">${f}</span>
                <button 
                    style="padding:4px 8px; font-size:12px; background:#e74c3c; color:white; border:none; border-radius:6px;"
                    onclick="deleteSensorFile('${encodeURIComponent(f)}')"
                >삭제</button>
            </div>
        `).join("");

                container.innerHTML = listHtml;

            } catch (err) {
                console.error(err);
                container.innerHTML = "목록을 불러오는 중 오류 발생.";
            }
        }

        async function deleteSensorFile(encodedName) {
            const filename = decodeURIComponent(encodedName);

            const ok = confirm(`정말 삭제할까요?\n${filename}`);
            if (!ok) return;

            try {
                const res = await fetch(`${API_BASE_URL}/sensor-files/${encodedName}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert(`삭제 실패 (${res.status})\n${text}`);
                    return;
                }

                alert("삭제 완료!");
                loadSensorFiles(); 

            } catch (err) {
                console.error(err);
                alert("삭제 중 오류 발생");
            }
        }


        function transformData(fiData, cmData, crData, safeData) {
            const mapping = { temp: "온도(temp)", press: "압력(press)", humid: "습도(humid)" };
            const featureImportance = {};

            (fiData.feature_importance || []).forEach((item) => {
                const label = mapping[item.feature] || item.feature;
                featureImportance[label] = item.importance;
            });

            const cm = cmData.confusion_matrix || {};
            const confusionMatrix = [
                [cm.normal_to_normal ?? 0, cm.normal_to_defect ?? 0],
                [cm.defect_to_normal ?? 0, cm.defect_to_defect ?? 0],
            ];

            const metrics = {
                accuracy: crData.accuracy ?? 0,
                class0: {
                    precision: crData["0"]?.precision ?? 0,
                    recall: crData["0"]?.recall ?? 0,
                    f1: crData["0"]?.["f1-score"] ?? 0,
                    support: crData["0"]?.support ?? 0,
                },
                class1: {
                    precision: crData["1"]?.precision ?? 0,
                    recall: crData["1"]?.recall ?? 0,
                    f1: crData["1"]?.["f1-score"] ?? 0,
                    support: crData["1"]?.support ?? 0,
                },
                safeRegion: safeData,
            };

            return {
                confusionMatrix,
                featureImportance,
                metrics,
            };
        }

        function updateSummaryCards(metrics) {
            document.getElementById("accuracy-value").innerText = metrics.accuracy.toFixed(4);
            document.getElementById("precision-value").innerText = metrics.class1.precision.toFixed(4);
            document.getElementById("recall-value").innerText = metrics.class1.recall.toFixed(4);
            document.getElementById("f1-value").innerText = metrics.class1.f1.toFixed(4);
        }

        function initCharts(modelData) {
            const cmCtx = document.getElementById("confusionMatrix").getContext("2d");
            if (charts.confusionMatrix) charts.confusionMatrix.destroy();
            charts.confusionMatrix = new Chart(cmCtx, {
                type: "bar",
                data: {
                    labels: [
                        "정상→정상", "정상→불량",
                        "불량→정상", "불량→불량"
                    ],
                    datasets: [
                        {
                            data: [
                                modelData.confusionMatrix[0][0],
                                modelData.confusionMatrix[0][1],
                                modelData.confusionMatrix[1][0],
                                modelData.confusionMatrix[1][1],
                            ],
                            backgroundColor: [
                                "rgba(75, 192, 192, 0.8)",
                                "rgba(255, 99, 132, 0.8)",
                                "rgba(255, 99, 132, 0.8)",
                                "rgba(75, 192, 192, 0.8)",
                            ],
                        },
                    ],
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const fiCtx = document.getElementById("featureImportance").getContext("2d");
            if (charts.featureImportance) charts.featureImportance.destroy();
            const features = Object.keys(modelData.featureImportance);
            const importance = Object.values(modelData.featureImportance);

            charts.featureImportance = new Chart(fiCtx, {
                type: "bar",
                data: {
                    labels: features,
                    datasets: [
                        {
                            data: importance,
                            backgroundColor: "rgba(102, 126, 234, 0.8)",
                        },
                    ],
                },
                options: {
                    indexAxis: "y",
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateTable(metrics) {
            const tbody = document.getElementById("reportBody");
            tbody.innerHTML = `
            <tr>
                <td>정상</td>
                <td>${metrics.class0.precision.toFixed(4)}</td>
                <td>${metrics.class0.recall.toFixed(4)}</td>
                <td>${metrics.class0.f1.toFixed(4)}</td>
                <td>${metrics.class0.support}</td>
            </tr>
            <tr>
                <td>불량</td>
                <td>${metrics.class1.precision.toFixed(4)}</td>
                <td>${metrics.class1.recall.toFixed(4)}</td>
                <td>${metrics.class1.f1.toFixed(4)}</td>
                <td>${metrics.class1.support}</td>
            </tr>
            <tr>
                <td>정확도</td>
                <td colspan="4">${metrics.accuracy.toFixed(4)}</td>
            </tr>
        `;
        }

        function switchView(view) {
            document.querySelectorAll(".tab-button").forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");

            document.getElementById("DataAnalysis-view").classList.remove("active");
            document.getElementById("AIInsight-view").classList.remove("active");

            if (view === "AIInsight") {
                document.getElementById("AIInsight-view").classList.add("active");
            } else {
                document.getElementById("DataAnalysis-view").classList.add("active");
            }
        }

        async function handleDataAdd() {
            const fileInput = document.getElementById("fileInput");
            if (!fileInput) return;
            fileInput.value = "";
            fileInput.click();
        }

        async function onFileSelected(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            try {
                let res;
                if (files.length === 1) {
                    const formData = new FormData();
                    formData.append("file", files[0]);
                    res = await fetch(`${API_BASE_URL}/upload-csv`, {
                        method: "POST",
                        body: formData
                    });
                } else {
                    const formData = new FormData();
                    Array.from(files).forEach((file) => {
                        formData.append("files", file);
                    });
                    res = await fetch(`${API_BASE_URL}/upload-multiple-csv`, {
                        method: "POST",
                        body: formData
                    });
                }

                if (!res.ok) throw new Error("업로드 실패");

                const doAnalyze = confirm("파일 업로드가 완료되었습니다. 이 데이터로 바로 분석을 시작할까요?");
                if (doAnalyze) {
                    await runFullAnalysisFlow();
                } else {
                    alert("분석 시작 버튼을 눌러 언제든 분석을 실행할 수 있습니다.");
                }
            } catch (err) {
                console.error(err);
                alert("파일 업로드 중 오류가 발생했습니다.");
            } finally {
                event.target.value = "";
            }
        }

        async function handleAnalyze() {
            await runFullAnalysisFlow();
        }

        async function waitForAnalysisCompleted({
            intervalMs = 2000,
            timeoutMs = 5 * 60 * 1000
        } = {}) {
            const startTime = Date.now();

            while (true) {
                const res = await fetch(`${API_BASE_URL}/analysis-status`);
                if (!res.ok) {
                    throw new Error("analysis-status 조회 실패");
                }

                const data = await res.json();
                const status = data.status;

                if (status === "completed") {
                    return;
                }
                if (status === "error") {
                    throw new Error(data.result?.error || "분석 중 오류 발생");
                }

                if (Date.now() - startTime > timeoutMs) {
                    throw new Error("분석이 너무 오래 걸립니다. (timeout)");
                }

                await sleep(intervalMs);
            }
        }

        // 페이지 로드 시 자동으로 분석 결과 불러오기
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // 백엔드에 이미 분석 결과가 있으면 자동으로 표시
                await fetchResultsAndRender();
                console.log('기존 분석 결과를 불러왔습니다.');
            } catch (err) {
                // 결과가 없거나 에러가 발생하면 조용히 무시
                // 사용자가 데이터를 추가하고 분석을 시작할 때까지 기본 상태 유지
                console.log('이전 분석 결과가 없습니다. 데이터를 추가하고 분석을 시작하세요.');
            }
        });

    </script>




</body>

</html>